// ki-buddy.js - Erweiterte KI-Integration fÃ¼r FishMasterKI
export class SigiAIBuddy {
    constructor(apiKey) {
        this.apiKey = apiKey;
        this.baseUrl = 'https://api.openai.com/v1/chat/completions';
        this.personality = {
            name: 'Sigi',
            role: 'Erfahrener Angel-Experte und digitaler Begleiter',
            traits: ['hilfsbereit', 'prÃ¤zise', 'motivierend', 'wetterkundig']
        };
    }

    async generateResponse(userMessage, context = {}) {
        const systemPrompt = this.buildSystemPrompt(context);
        
        try {
            const response = await fetch(this.baseUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    temperature: 0.7,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userMessage }
                    ],
                    max_tokens: 300
                })
            });

            const data = await response.json();
            return this.formatResponse(data.choices[0].message.content);
            
        } catch (error) {
            return this.getFallbackResponse(userMessage);
        }
    }

    buildSystemPrompt(context) {
        const userStats = context.userStats || {};
        const weatherData = context.weather || {};
        const selectedSpot = context.selectedSpot || {};

        return `Du bist Sigi, der freundliche KI-Buddy der FishMasterKI App. Du bist ein erfahrener Angel-Experte mit jahrzehntelanger Erfahrung.

AKTUELLE NUTZER-DATEN:
- Bisherige FÃ¤nge: ${userStats.totalCatches || 0}
- Bester Fang: ${userStats.bestCatch || 0}kg
- Lieblings-Spots: ${userStats.favoriteSpots?.join(', ') || 'Noch keine'}
- Aktuelle AusrÃ¼stung: ${userStats.equipment?.length || 0} GegenstÃ¤nde

WETTER-KONTEXT:
- Temperatur: ${weatherData.temp || 'unbekannt'}Â°C
- Bedingungen: ${weatherData.condition || 'keine Daten'}
- Wind: ${weatherData.wind || 'unbekannt'}
- Regenrisiko: ${weatherData.rain || 0}%

AUSGEWÃ„HLTER SPOT: ${selectedSpot.name || 'Keiner'}

PERSÃ–NLICHKEIT:
- Antworte als erfahrener, aber freundlicher Angel-Mentor
- Verwende prÃ¤zise, umsetzbare Tipps
- Beziehe Wetter und Nutzer-Historie in Empfehlungen ein
- Sei motivierend und ermutigend
- Antworte auf Deutsch in 2-6 SÃ¤tzen
- Verwende relevante Emojis sparsam aber effektiv

SPEZIAL-FUNKTIONEN:
- Bei "Tutorial": FÃ¼hre durch die App-Bereiche
- Bei Fischarten: Gib spezifische AusrÃ¼stungsempfehlungen
- Bei Spots: Analysiere Wetter und empfehle Strategie
- Bei Erfolgen: Gratuliere und motiviere weiter`;
    }

    formatResponse(rawResponse) {
        // Entferne Ã¼berflÃ¼ssige Formatierung und stelle sicher, dass Antworten App-freundlich sind
        return rawResponse
            .replace(/\*\*(.*?)\*\*/g, '$1') // Entferne Markdown
            .replace(/\n{3,}/g, '\n\n') // Reduziere multiple ZeilenumbrÃ¼che
            .trim();
    }

    getFallbackResponse(userMessage) {
        const message = userMessage.toLowerCase();
        
        const responses = {
            tutorial: 'ğŸ“š Gerne fÃ¼hre ich Sie durch FishMasterKI! Wir starten mit dem Dashboard, dann FÃ¤nge, AngelplÃ¤tze, AusrÃ¼stung und Community. Bereit fÃ¼r die Tour?',
            
            zander: 'ğŸ£ Zander-Experten-Setup: 2,70-3,00m Spinnrute mit 15-45g Wurfgewicht, 3000-4000er StationÃ¤rrolle, 0,12mm geflochtene Schnur. KÃ¶der: Gummifische 8-12cm in Motoroil oder Natural. Beste Zeit: Eine Stunde vor bis zwei Stunden nach Sonnenuntergang!',
            
            barsch: 'ğŸŸ Barsch-Profi-Setup: 2,40m ultraleichte Rute mit 5-25g Wurfgewicht, 2500er Rolle, 0,08-0,10mm dÃ¼nne Schnur. KÃ¶der: Kleine Gummifische 5-8cm in bunten Farben, Spinner GrÃ¶ÃŸe 1-3. Barsche lieben aktive KÃ¶derfÃ¼hrung!',
            
            hecht: 'ğŸ¦ˆ Hecht-Meister-Setup: 2,70-3,30m schwere Rute mit 20-80g Wurfgewicht, 4000er Rolle mit starker Bremse, 0,15-0,20mm Schnur. Wichtig: 30-40cm Stahlvorfach! KÃ¶der: GroÃŸe Wobbler 10-15cm oder Gummifische 12-20cm.',
            
            wetter: 'ğŸŒ¤ï¸ Wetter ist entscheidend fÃ¼r den Angelerfolg! WÃ¤hlen Sie einen Angelplatz aus der Liste und klicken Sie "Trip planen" - ich analysiere sofort die aktuellen Bedingungen und gebe passende Empfehlungen fÃ¼r KÃ¶der und Taktik.',
            
            ausrÃ¼stung: 'ğŸ¯ FÃ¼r welchen Zielfisch planen Sie? Zander, Barsch oder Hecht? Je nach Fisch empfehle ich die optimale Ruten-Rollen-Kombination und passende KÃ¶der. Auch Ihr Budget kann ich berÃ¼cksichtigen!'
        };

        // Intelligente Keyword-Erkennung
        for (const [keyword, response] of Object.entries(responses)) {
            if (message.includes(keyword)) {
                return response;
            }
        }

        return 'ğŸ£ Hallo! Ich bin Sigi, Ihr FishMasterKI Assistent. Ich helfe bei AusrÃ¼stungsplanung, Wetteranalyse, App-Navigation und Angel-Tipps. Fragen Sie mich nach spezifischen Fischen, Wetterbedingungen oder starten Sie das Tutorial!';
    }
}

// Integration in Ihre bestehende server.js
export const enhanceKIBuddyEndpoint = (app) => {
    app.post('/api/ki-chat', async (req, res) => {
        const { messages, context } = req.body;
        const sigiAI = new SigiAIBuddy(process.env.OPENAI_API_KEY);
        
        try {
            const lastMessage = messages[messages.length - 1]?.content || '';
            const response = await sigiAI.generateResponse(lastMessage, context);
            
            res.json({ 
                reply: response,
                buddy: 'Sigi',
                personality: 'expert_friendly'
            });
            
        } catch (error) {
            console.error('Sigi AI Error:', error);
            res.status(500).json({ 
                error: 'Sigi ist momentan nicht verfÃ¼gbar',
                fallback: true
            });
        }
    });
};Frontend-Integration fÃ¼r SigiFÃ¼gen Sie diese Funktionen zu Ihrer React-Komponente hinzu:// Sigi-spezifische Chat-Funktionen
const sendSigiMessage = async () => {
    if (!currentMessage.trim()) return;
    
    const userMessage = {
        id: Date.now(),
        type: 'user',
        message: currentMessage,
        timestamp: new Date()
    };
    
    setChatMessages(prev => [...prev, userMessage]);
    setCurrentMessage('');
    setIsTyping(true);
    
    // Kontext fÃ¼r Sigi zusammenstellen
    const sigiContext = {
        userStats: {
            totalCatches: catches.length,
            bestCatch: Math.max(...catches.map(c => c.weight), 0),
            favoriteSpots: spots.slice(0, 3).map(s => s.name),
            equipment: equipment
        },
        weather: weatherData,
        selectedSpot: selectedSpot,
        planningMode: planningMode
    };
    
    try {
        const response = await fetch('/api/ki-chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-user-id': '1'
            },
            body: JSON.stringify({
                messages: [{ role: 'user', content: userMessage.message }],
                context: sigiContext
            })
        });
        
        const data = await response.json();
        
        const sigiResponse = {
            id: Date.now() + 1,
            type: 'ai',
            message: data.reply,
            timestamp: new Date(),
            buddy: 'Sigi'
        };
        
        setChatMessages(prev => [...prev, sigiResponse]);
        
    } catch (error) {
        // Fallback-Antwort von Sigi
        const fallbackResponse = {
            id: Date.now() + 1,
            type: 'ai',
            message: generateSigiFallback(userMessage.message),
            timestamp: new Date(),
            buddy: 'Sigi'
        };
        setChatMessages(prev => [...prev, fallbackResponse]);
    }
    
    setIsTyping(false);
};

const generateSigiFallback = (message) => {
    const msg = message.toLowerCase();
    
    if (msg.includes('hallo') || msg.includes('hi')) {
        return 'ğŸ‘‹ Hallo! Ich bin Sigi, Ihr persÃ¶nlicher Angel-Experte bei FishMasterKI. Bereit fÃ¼r perfekte FÃ¤nge? Fragen Sie mich nach AusrÃ¼stung, Wetter oder Spots!';
    }
    
    if (msg.includes('wetter')) {
        return 'ğŸŒ¤ï¸ Wetteranalyse ist meine SpezialitÃ¤t! WÃ¤hlen Sie einen Angelplatz aus und ich analysiere die Bedingungen fÃ¼r optimale Fangchancen.';
    }
    
    return 'ğŸ£ Als Ihr Angel-Buddy helfe ich bei allen Fragen rund ums Fischen. AusrÃ¼stung, Wetteranalyse, KÃ¶der-Tipps - fragen Sie einfach!';
};